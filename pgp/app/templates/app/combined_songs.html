{% extends "base.html" %}

{% block title %}Totallista{% endblock %}

{% block content %}
<div class="container mx-auto my-8">
    <div class="flex flex-col items-center mb-4">
        <h1 class="text-2xl font-bold">Totallista</h1>
        <div id="totalSongsDisplay" class="text-lg font-medium text-center">
            <!-- Total songs display -->
        </div>
    </div>
    
    <!-- Reset Button -->
    <div class="mb-4 text-center">
        <button id="resetButton" class="bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600 transition-colors">
            Nullstill
        </button>
    </div>
    
    <div class="overflow-x-auto sm:rounded-lg">
        <table id="songsTable" class="min-w-full divide-y divide-gray-200 text-sm sm:text-base">
            <thead>
                <tr class="bg-gray-100">
                    <th class="px-4 py-2 text-left text-sm font-medium text-gray-600">Dato</th>
                    <th class="px-4 py-2 text-left text-sm font-medium text-gray-600">Artist</th>
                    <th class="px-4 py-2 text-left text-sm font-medium text-gray-600">Tittel</th>
                    <th class="px-4 py-2 text-left text-sm font-medium text-gray-600">Levert av</th>
                    <th class="px-4 py-2 text-left text-sm font-medium text-gray-600">Tema</th>
                    <th class="px-4 py-2 text-left text-sm font-medium text-gray-600">Spotify</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                <!-- DataTables will populate these rows dynamically -->
            </tbody>
        </table>
    </div>
</div>

<link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>

<script>
    $(document).ready(function() {
        var table = $('#songsTable').DataTable({
            processing: true,
            serverSide: true,
            searchDelay: 400,  // âœ… ADD: Prevent search on every keystroke
            ajax: {
                url: "{% url 'combined_song_data_view' %}",
                type: "GET",
                data: function (d) {
                    // âœ… ADD: Don't search on very short terms (less than 3 characters)
                    if (d.search && d.search.value && d.search.value.length > 0 && d.search.value.length < 3) {
                        d.search.value = '';
                    }
                    
                    d.page = Math.ceil(d.start / d.length) + 1;
                    d.pageSize = d.length;
                    if (d.order && d.order.length > 0) {
                        d.orderColumn = d.columns[d.order[0].column].data;
                        d.orderDir = d.order[0].dir;
                    }
                },
                dataSrc: function(json) {
                    return json.data;
                },
                // âœ… ADD: Error handling for failed requests
                error: function(xhr, error, code) {
                    console.log('Error loading data:', error);
                    alert('Feil ved lasting av data. PrÃ¸v igjen.');
                }
            },
            columns: [
                { data: 'dato' },
                { data: 'artist' },
                { data: 'tittel' },
                { data: 'levert_av' },
                { data: 'tema' },
                { data: 'spotify', render: function(data) {
                    return `<a href="${data}" target="_blank" class="text-blue-500 hover:underline">ðŸŽµ LÃ¥t</a>`;
                }}
            ],
            order: [[0, 'desc']],
            paging: true,
            searching: true,
            ordering: true,
            pageLength: 10,
            // âœ… ADD: More page length options for users
            lengthMenu: [[10, 25, 50, 100], [10, 25, 50, 100]],
            language: {
                processing: "Laster...",
                search: "SÃ¸k:",
                searchPlaceholder: "SÃ¸k i artist, tittel, tema...", // âœ… ADD: Helpful placeholder
                lengthMenu: "Vis _MENU_ bidrag per side",
                info: "Viser _START_ til _END_ av _TOTAL_ bidrag", 
                infoEmpty: "Ingen bidrag tilgjengeleg", 
                infoFiltered: "(filtrert frÃ¥ _MAX_ totale bidrag)", 
                paginate: {
                    first: "FÃ¸rste",
                    last: "Siste",
                    next: "Neste",
                    previous: "FÃ¸rre"
                },
                zeroRecords: "Ingen bidrag funne. PrÃ¸v eit anna sÃ¸keord."
            },
            drawCallback: function(settings) {
                var api = this.api();
                var json = api.ajax.json();

                // Display the total number of songs
                var totalSongs = json.recordsTotal;
                var filteredSongs = json.recordsFiltered;
                
                // âœ… IMPROVED: Show both total and filtered count
                if (totalSongs === filteredSongs) {
                    $('#totalSongsDisplay').text(`Totalt antall bidrag: ${totalSongs}`);
                } else {
                    $('#totalSongsDisplay').text(`Visar ${filteredSongs} av ${totalSongs} bidrag`);
                }
            },
            // âœ… ADD: Loading state improvements
            initComplete: function() {
                console.log('DataTable loaded successfully');
                
                // Add search hint
                $('.dataTables_filter input').attr('placeholder', 'SÃ¸k (minimum 3 bokstavar)...');
            }
        });

        // âœ… IMPROVED: Reset button with feedback
        $('#resetButton').on('click', function() {
            $(this).text('Nullstiller...').prop('disabled', true);
            
            table.search('').columns().search('').draw();
            
            setTimeout(() => {
                $(this).text('Nullstill').prop('disabled', false);
            }, 500);
        });
        
        // âœ… ADD: Keyboard shortcut for search focus
        $(document).on('keydown', function(e) {
            if (e.ctrlKey && e.key === 'f') {
                e.preventDefault();
                $('.dataTables_filter input').focus();
            }
        });
    });
</script>

<style>
    .overflow-x-auto .dataTables_filter input {
        border: 1px solid #ccc;
        border-radius: 4px;  /* âœ… IMPROVED: Better border radius */
        padding: 0.5em;
        background-color: white;
        min-width: 250px;  /* âœ… ADD: Wider search box */
    }

    .dataTables_wrapper .dataTables_length select {
        border: 1px solid #aaa;
        border-radius: 3px;
        padding: 5px;
        background-color: white;
    }
    
    /* âœ… ADD: Better loading state */
    .dataTables_processing {
        background: rgba(255, 255, 255, 0.9) !important;
        border: 1px solid #ddd !important;
        border-radius: 4px !important;
    }
    
    /* âœ… ADD: Search hint styling */
    .dataTables_filter {
        margin-bottom: 1rem;
    }
    
    .dataTables_filter::after {
        content: "ðŸ’¡ Trykk Ctrl+F for rask sÃ¸k";
        display: block;
        font-size: 0.75rem;
        color: #666;
        margin-top: 0.25rem;
    }
    
    /* âœ… ADD: Better button styling */
    #resetButton:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
</style>
{% endblock %}
